---
title: "Visualization and Analysis of IncuCyte Output"
author: "Maia Smith"
date: "February 9, 2015"
runtime: shiny
output:
  html_document:
    keep_md: yes
---

```{r, echo=FALSE, warnings=FALSE}
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)
library(knitr)
library(devtools)
library(car)
library(plotly)
library(reshape2)
library(gplots)
library(RColorBrewer)
py <- plotly("mas29", "8s6jru0os3")

# Get data
source("/Users/maiasmith/Documents/SFU/ClarkeLab/ClarkeLab_github/Scripts/GetData.R")

data_for_stats <- confluency_sytoxG_data
```

```{r setup, include=FALSE}
opts_chunk$set(out.width='1000px', dpi=200)
```

Quality Control
=============

Compare controls and treatments
-----------------------------------------------
```{r, eval=FALSE, echo=FALSE}
plot <- ggplot(sytoxG_data, aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), text=Compound, group=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green Over Time - Control vs Treatment") +
  facet_grid(~empty, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"), 
        axis.text = element_blank())
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="SG_control_vs_treatment", fileopt="overwrite"))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/225/sytox-green-over-time-control-vs-treatment.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, 
    "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

```{r, eval=FALSE, echo=FALSE}
plot <- ggplot(confluency_data, aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), text=Compound, group=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle("Confluency Over Time - Control vs Treatment") +
  facet_grid(~empty, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"), 
        axis.text = element_blank())
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="Con_control_vs_treatment", fileopt="overwrite"))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/223/confluency-over-time-control-vs-treatment.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, 
    "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

Compare plates for controls and treatments
-----------------------------------------------

```{r, echo=FALSE}
# compare sytoxG sparklines, faceted by plates, empty
ggplot(sytoxG_data, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green Over Time - By Plate") +
  facet_grid(empty ~ Plate, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"))

# compare confluency sparklines, faceted by plates, empty
ggplot(confluency_data, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle("Confluency Over Time - By Plate") +
  facet_grid(empty ~ Plate, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"))
```

Compare sparklines for each plate, controls vs treatments, with mean and sd for each plate and control/treatment
-----------------------------------------------

```{r, echo=FALSE}
#sytoxG - calculate mean and sd values for each plate, empty vs not empty
sytoxG_mean_sd_empty <- ddply(sytoxG_data, ~ Plate * time_elapsed * empty, summarize,
                              mean = mean(phenotype_value), sd = sd(phenotype_value))

#sytoxG - plot mean and sd values for each plate, neg.control vs others - using geom_ribbon()
ggplot(sytoxG_mean_sd_empty, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(mean), colour = as.factor(Plate), group = Plate)) +
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd), alpha=0.2) + 
  facet_grid(~ empty, scales = "fixed") +
  xlab("Time Elapsed") +
  ylab("Sytox Green Mean & SD") +
  scale_colour_discrete(name="Plate") +
  ggtitle("Sytox Green\nPlate Mean & SD (line size)\nNegative Control T/F (facets)") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white")) 

#confluency - calculate mean and sd values for each plate, empty vs not empty
con_mean_sd_empty <- ddply(confluency_data, ~ Plate * time_elapsed * empty, summarize,
                              mean = mean(phenotype_value), sd = sd(phenotype_value))

#confluency - plot mean and sd values for each plate, neg.control vs others - using geom_ribbon()
ggplot(con_mean_sd_empty, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(mean), colour = as.factor(Plate), group = Plate)) +
  geom_ribbon(aes(ymin=mean-sd, ymax=mean+sd), alpha=0.2) + 
  facet_grid(~ empty, scales = "fixed") +
  xlab("Time Elapsed") +
  ylab("Confluency Mean & SD") +
  scale_colour_discrete(name="Plate") +
  ggtitle("Confluency\nPlate Mean & SD (line size)\nNegative Control T/F (facets)") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white")) 
```

Sparklines for Each Compound 
================

```{r, echo=FALSE, fig.width=26, fig.height=26} 
# No negative controls included.
# SG
ggplot(sytoxG_data_no_NC, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), 
           group=Compound)) +
  geom_rect(data = sytoxG_data_no_NC, aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = delta_min_max), alpha = 0.4) +
  geom_line() +
  scale_fill_gradient2(low = "red", mid = "white", high = "red",
                       midpoint = 0, space = "rgb", na.value = "grey50", guide = "colourbar") + 
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green - Muscle Cells Over Time") +
  facet_wrap(~ Compound, ncol = 43, scales = "fixed") +
  labs(fill = "Delta\n(max-min)") +
  theme(panel.grid = element_blank(),
        strip.text=element_blank(),
        axis.text = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        legend.key.height = unit(.85, "cm"),
        panel.background = element_rect(fill = "white"),
        panel.margin = unit(.085, "cm"),
        axis.title.x = element_text(size = 20.5, angle = 00),
        axis.title.y = element_text(size = 20.5, angle = 90),
       title = element_text(size = 35, angle = 00),
        legend.text = element_text(size = 20.5, angle = 00))

# Confluency
ggplot(confluency_data_no_NC, 
       aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), 
           group=Compound)) +
  geom_rect(data = confluency_data_no_NC, aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = delta_min_max), alpha = 0.4) +
  geom_line() +
  scale_fill_gradient2(low = "red", mid = "white", high = "red",
                       midpoint = 0, space = "rgb", na.value = "grey50", guide = "colourbar") + 
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle("Confluency - Muscle Cells Over Time") +
  facet_wrap(~ Compound, ncol = 43, scales = "fixed") +
  labs(fill = "Delta\n(max-min)") +
  theme(panel.grid = element_blank(),
        strip.text=element_blank(),
        axis.text = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        legend.key.height = unit(.85, "cm"),
        panel.background = element_rect(fill = "white"),
        panel.margin = unit(.085, "cm"),
        axis.title.x = element_text(size = 20.5, angle = 00),
        axis.title.y = element_text(size = 20.5, angle = 90),
       title = element_text(size = 35, angle = 00),
        legend.text = element_text(size = 20.5, angle = 00))
```

Explore individual compounds
================

```{r, echo=FALSE}
# Get axis limits
y_limits_SG <- c(min(sytoxG_data$phenotype_value), max(sytoxG_data$phenotype_value))
y_limits_Con <- c(min(confluency_data$phenotype_value), max(confluency_data$phenotype_value))

# Get list of compounds
compounds <- unique(sytoxG_data_no_NC$Compound)
compound_list <- as.list(setNames(compounds, compounds))

# Function to plot 
plot <- function(df, confidence_intervals, phenotypic_marker_name, phenotypic_marker_units, y_axis_limits, compound) {
  ggplot() +
    geom_line(data = df, aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound)) +
    geom_ribbon(data = confidence_intervals, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, 
                                                           ymax = phenotype_value.NC.upper, fill = "red", colour = NULL), alpha = 0.2) +
    scale_fill_manual(name = "Legend", values = 'red', labels = paste(phenotypic_marker_name,'\nNegative Control\n99.9% C.I.',sep="")) +
    xlab("Time Elapsed (hours)") +
    ylab(paste(phenotypic_marker_name," ",phenotypic_marker_units,sep="")) +
    ggtitle(paste(phenotypic_marker_name," Levels for ",compound," Over Time",sep="")) +
    scale_y_continuous(limits = c(y_axis_limits[1], y_axis_limits[2])) +
    theme(panel.grid = element_blank(),
          strip.text=element_blank(),
          legend.key.height = unit(.85, "cm"),
          panel.background = element_rect(fill = "white"),
          panel.margin = unit(.085, "cm"))
  }

exploreIndividualCompounds <- function() { 
  
  require(shiny)  
  
  shinyApp(
    
    # UI
    
    ui = fluidPage(
      
      # Application title
      titlePanel("Explore Selected Compound"),
      
      # Sidebar with a slider input for the number of bins
      sidebarLayout(
        sidebarPanel(
          selectizeInput(
            "compound", 'Select or Type Compound of Interest', choices = compound_list,
            multiple = FALSE
            ),
          radioButtons("marker", "Phenotypic Marker:",
                       c("Sytox Green" = "Sytox Green",
                         "Confluency" = "Confluency"))
          ),
        
        # Show a plot of the generated distribution
        mainPanel(
          plotOutput("sparklines")
          )
        )
      ),
    
    # Server
    
    server = function(input, output) {
      
      # Expression that generates a sparkline for the selected compound. The expression is
      # wrapped in a call to renderPlot to indicate that:
      #
      #  1) It is "reactive" and therefore should re-execute automatically
      #     when inputs change
      #  2) Its output type is a plot
      
      output$sparklines <- renderPlot({
        
        sytoxG_data_no_NC.sub <- sytoxG_data_no_NC[sytoxG_data_no_NC$Compound == input$compound,] 
        confluency_data_no_NC.sub <- confluency_data_no_NC[confluency_data_no_NC$Compound == input$compound,] 
        
        if (input$marker == "Sytox Green") {
          plot(sytoxG_data_no_NC.sub, confidence_intervals_SG, "Sytox Green", "(green cells / mm^2)", y_limits_SG, input$compound)
          }
        else if (input$marker == "Confluency") {
          plot(confluency_data_no_NC.sub, confidence_intervals_Con, "Confluency", "(% area occupied by cells)", y_limits_Con, input$compound)
          }
        })
      },
    
    options = list(height = 500)
    )
  }

exploreIndividualCompounds()
```

Pathway analysis 
================

Sparklines by Pathway
------------------------

Compared to negative controls:

```{r, echo=FALSE}

# SG
ggplot(sytoxG_data) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound, text=Compound)) +
  geom_ribbon(data = confidence_intervals_SG, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                                                            fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green - Facets: Pathway") +
  facet_wrap(~Pathway, ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical")

# Confluency
ggplot(confluency_data) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound, text=Compound)) +
  geom_ribbon(data = confidence_intervals_Con, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                                                             fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle("Confluency - Facets: Pathway") +
  facet_wrap(~Pathway, ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical")
```

In Plotly:

```{r, eval=FALSE, echo=FALSE} 
plot <- ggplot(sytoxG_data, 
               aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound,
                   text=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green - Facets: Pathway") +
  facet_wrap(~Pathway, ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank())
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="SG_sparklines_by_pathway", fileopt="overwrite"))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/227/sytox-green-facets-pathway.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

```{r, eval=FALSE, echo=FALSE} 
plot <- ggplot(confluency_data, 
               aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound,
                   text=Compound)) +
  geom_line() +
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle("Confluency - Facets: Pathway") +
  facet_wrap(~Pathway, ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank())
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="Con_sparklines_by_pathway", fileopt="overwrite"))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/230/confluency-facets-pathway.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

Delta (max-min) values by Pathway
----------------------------------

```{r, eval=FALSE, echo=FALSE}
plot <- ggplot(sytoxG_data_features, aes(Pathway, delta_min_max, text=Compound)) + 
  geom_point(alpha=0.4) +
  ylab("Delta (max-min)") +
  ggtitle("Sytox Green Delta (max-min) by Pathway") +
  theme(panel.grid = element_blank(),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size=6, angle=75))
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="SG_delta_by_pathway", fileopt="overwrite", layout=list(hovermode="closest")))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/233.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

```{r, eval=FALSE, echo=FALSE}
plot <- ggplot(confluency_data_features, aes(Pathway, delta_min_max, text=Compound)) + 
  geom_point(alpha=0.4) +
  ylab("Delta (max-min)") +
  ggtitle("Confluency Delta (max-min) by Pathway") +
  theme(panel.grid = element_blank(),
        panel.background = element_rect(fill = "white"),
        axis.text.x = element_text(size=6, angle=75))
response <- py$ggplotly(plot, kwargs=list(world_readable=FALSE, filename="Con_delta_by_pathway", fileopt="overwrite", layout=list(hovermode="closest")))
url <- response$response$url
```

```{r, echo=FALSE}
url<-"https://plot.ly/~mas29/235.embed?width=550&height=550" 
plotly_iframe <- paste("<center><iframe scrolling='no' seamless='seamless' style='border:none' src='", url, "/800/1200' width='800' height='800'></iframe><center>", sep = "")
```
`r I(plotly_iframe)`

Heatmap of metrics for all compounds (not negative controls) using Sytox Green Data
=========

```{r, echo=FALSE, include=FALSE}
# Select metrics of interest, for all compounds (no negative controls)
data_for_heatmap <- sytoxG_data_features[sytoxG_data_features$Pathway != "NegControl", 
                                         names(sytoxG_data_features) %in% c("time_x_distance.upper", "phenotype_value_exceeds_NC_upperbound.timepoint", "time_to_max")]
rownames(data_for_heatmap) <- sytoxG_data_features[sytoxG_data_features$Pathway != "NegControl", 
                                                   names(sytoxG_data_features) == "Compound"]
data_for_heatmap$phenotype_value_exceeds_NC_upperbound.timepoint[which(is.na(data_for_heatmap$phenotype_value_exceeds_NC_upperbound.timepoint))] <- -1

# Scale metrics.
data_for_heatmap <- scale(data_for_heatmap)
data_matrix <- as.matrix(data_for_heatmap)

# Get row and column dendrograms
hr <- hclust(as.dist(1-cor(t(data_matrix), method="pearson")), method="complete"); 
hc <- hclust(as.dist(1-cor(data_matrix, method="spearman")), method="complete")  

# Cut the tree and create color vector for clusters.
num_clusters <- 20
mycl <- cutree(hr, k = num_clusters) # Clusters assigned to each compound.
mycolhc <- rainbow(length(unique(mycl)), start=0.1, end=0.9)
mycolhc <- mycolhc[as.vector(mycl)] 

# Creates heatmap for entire data set -- obtained clusters are indicated in the color bar.
my_palette <- colorRampPalette(c("red", "white", "green"))(n = 299)
heatmap.2(data_matrix, 
          Rowv=as.dendrogram(hr), 
          Colv=as.dendrogram(hc), 
          density.info="none", 
          trace="none", 
          col=my_palette, 
          RowSideColors=mycolhc,
          cexRow = 0.8, 
          cexCol = 0.8, 
          srtCol = 45,
          labCol=c("Time to\nMaximum", "Timepoint When\nSG Exceeds\nNeg.Contr.\nUpperbound", "Time X Distance to\nNeg.Contr.\nUpperbound"))

# Print color key for cluster assignments. (Numbers beside color boxes correspond to the cluster numbers in 'mycl').
names(mycolhc) <- names(mycl); 
barplot(rep(10, max(mycl)), col=unique(mycolhc[hr$labels[hr$order]]), horiz=T, names=unique(mycl[hr$order])) 

# Select sub-cluster number(s) and generate corresponding dendrogram.
zoom <- function(cluster_num) {
  clid <- cluster_num
  data_matrix.sub <- data_matrix[names(mycl[mycl%in%clid]),]
  hrsub <- hclust(as.dist(1-cor(t(data_matrix.sub), method="pearson")), method="complete") 
  
  # Create heatmap for chosen sub-cluster(s).
  heatmap.2(data_matrix.sub, 
            Rowv=as.dendrogram(hrsub), 
            Colv=as.dendrogram(hc), 
            density.info="none", 
            trace="none", 
            col=my_palette, 
            RowSideColors=mycolhc[mycl%in%clid],
            cexRow = 0.7, 
            cexCol = 0.8, 
            srtCol = 45,
            labCol=c("Time to\nMaximum", "Timepoint When\nSG Exceeds\nNeg.Contr.\nUpperbound", "Time X Distance to\nNeg.Contr.\nUpperbound")) 
}

# Print all the clusters
for(i in 1:num_clusters) {
  zoom(i)
}
```

Comparison to Negative Controls
================

```{r, echo=FALSE}
# Plot SG
ggplot(sytoxG_data_no_NC) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group = Compound), alpha = 0.6) +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Time Point at which Compound Surpasses Negative Control\n(Phenotypic Marker: Sytox Green)") +
  geom_ribbon(data = confidence_intervals_SG, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                             fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  facet_wrap(~phenotype_value_exceeds_NC_upperbound.timepoint, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical") 

# Plot confluency
ggplot(confluency_data_no_NC) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group = Compound), alpha = 0.6) +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Time Point at which Compound Drops Below Negative Control\n(Phenotypic Marker: Confluency)") +
  geom_ribbon(data = confidence_intervals_Con, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                                                         fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  facet_wrap(~phenotype_value_falls_below_NC_lowerbound.timepoint, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical")
```

Cluster Analysis
============

```{r}
# Parameters
start_index <- which(colnames(confluency_sytoxG_data_prelim_proc) == "0")
end_index <- which(colnames(confluency_sytoxG_data_prelim_proc) == "46")
num_time_intervals <- length(unique(sytoxG_data$time_elapsed)) # Number of time intervals
num_clusters <- 12

# Confidence interval bounds
confidence_intervals_SG <- sytoxG_data[1:num_time_intervals,c("time_elapsed", "phenotype_value.NC.upper", "phenotype_value.NC.mean", "phenotype_value.NC.lower")]

# Get Sytox Green raw time series data only, for all compounds (including negative controls)
data_for_heatmap <- confluency_sytoxG_data_prelim_proc[confluency_sytoxG_data_prelim_proc$phenotypic_Marker == "SG", start_index:end_index]
rownames(data_for_heatmap) <- confluency_sytoxG_data_prelim_proc[confluency_sytoxG_data_prelim_proc$phenotypic_Marker == "SG",]$Compound
data_matrix <- as.matrix(data_for_heatmap)

# Get distances (Euclidean) and clusters
distMatrix <- dist(data_matrix, method="euclidean")
hr <- hclust(distMatrix, method="average")

# Cut the tree and create color vector for clusters.
mycl <- cutree(hr, k = num_clusters) # Clusters assigned to each compound.
mycolhc <- rainbow(length(unique(mycl)), start=0.1, end=0.9)
mycolhc <- mycolhc[as.vector(mycl)] 

# Plot all clusters
compound_clusters <- as.data.frame(mycl)
colnames(compound_clusters) <- "cluster"
compound_clusters$cluster <- as.factor(compound_clusters$cluster)
sytoxG_data_w_clusters <- merge(sytoxG_data, compound_clusters, by.x="Compound", by.y="row.names")

ggplot(sytoxG_data_w_clusters) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound, text=Compound)) +
  geom_ribbon(data = confidence_intervals_SG, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                                                            fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle("Sytox Green Sparklines for Each Cluster") +
  facet_grid(empty~cluster) +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank())
```

Statistical Analyses
===================

Q-Q Plots vs Histograms of Negative Control and Treatment for each Curve Metric
--------------

```{r, echo=FALSE, fig.width=10, fig.height=13}
# Function to extract legend
# From: https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

# Get histogram for one metric

# @param df -- data frame of data with metrics 
# @param metric_name -- name of metric to explore
get_single_metric_hist <- function(df, metric_name) {
  # Distributions to compare
  metric_NC <- df[df$empty == "Negative Control", colnames(df) == metric_name]
  metric_Treatment <- df[df$empty == "Treatment", colnames(df) == metric_name]
  
  # Plot
  plot <- ggplot() + 
    # As density
    geom_density(data = data.frame(metric_NC), aes(x = metric_NC, fill = 'Negative Control'), alpha = 0.5) + 
    geom_density(data = data.frame(metric_Treatment), aes(x = metric_Treatment, fill = 'Treatment'), alpha = 0.5) + 
    xlab(metric_name) +
    guides(fill=guide_legend(title="Legend", direction="horizontal")) +
    theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank(),
          legend.key.width = unit(0.5, "cm")) 
  
  return(plot)
}

# Get qqplot for one metric

# @param df -- data frame of data with metrics 
# @param metric_name -- name of metric to explore
get_single_metric_qqplot <- function(df, metric_name) {
  # Distributions to compare
  metric_NC <- df[df$empty == "Negative Control", colnames(df) == metric_name]
  metric_Treatment <- df[df$empty == "Treatment", colnames(df) == metric_name]
  
  # Calculated quantiles
  q1 <- quantile(scale(metric_NC),0:100/100)
  q2 <- quantile(scale(metric_Treatment),0:100/100)
  
  # Plot
  plot <- ggplot(data=data.frame(a=q1,b=q2)) + 
    geom_point(aes(x=a,y=b)) +
    geom_abline(intercept=0,slope=1) +
    theme_bw() +
    xlab("Negative Control") +
    ylab("Treatment") +
    theme(axis.line = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          panel.background = element_blank()) 
  
  return(plot)
}

# Get Q-Q Plot of the negative control sample quantiles for all features against non-negative control sample quantiles 

# @param df -- data frame of data with metrics 
# @param metric_var_names -- variable names in data frame for metrics we want to look at
# @param metric_titles -- titles for each individual metric
# @param main_title -- title for all graphs
get_qq_hist_comparison <- function(df, metric_var_names, metric_titles, main_title) {
  
  num_metrics <- length(metric_var_names)
  pushViewport(viewport(layout = grid.layout((num_metrics*2 + 2), 2, widths = unit(c(3,7), "null"), heights = unit(c(1, rep(c(1,4),num_metrics)), "null"))))
  grid.text(main_title, vp = viewport(layout.pos.row = 1, layout.pos.col = 1:2))
  
  for (i in 1:num_metrics) {
    # Get qq plot and get histogram for current metric
    qq <- get_single_metric_qqplot(df, metric_var_names[i])
    hist <- get_single_metric_hist(df, metric_var_names[i])
    # Print title to both graphs and the graphs themselves
    grid.text(metric_titles[i], vp = viewport(layout.pos.row = i*2, layout.pos.col = 1:2))
    print(qq, vp = viewport(layout.pos.row = (i*2 + 1), layout.pos.col = 1))
    print(hist + theme(legend.position="none"), vp = viewport(layout.pos.row = (i*2 + 1), layout.pos.col = 2))
  }
  
  # Get legend
  mylegend <- g_legend(get_single_metric_hist(df, metric_var_names[1]))
  mylegend$vp$x <- unit(.8, 'npc')
  mylegend$vp$y <- unit(.02, 'npc')
  grid.draw(mylegend)
}

# SG
get_qq_hist_comparison(sytoxG_data_features, c("delta_min_max", "time_to_max", "time_x_distance.upper", "time_to_most_positive_slope", "mean", "min", "AUC_trapezoidal_integration"), 
          c("Delta (max-min)", "Time To Max", "Time*Distance", "Time To Most Positive Slope", "Mean", "Min", "AUC (trapezoidal integration)"), "Sytox Green Metrics - Q-Q Plot & Histogram")
```

```{r, echo=FALSE, fig.width=10, fig.height=13}
# Confluency
get_qq_hist_comparison(confluency_data_features, c("delta_min_max", "time_to_max", "time_x_distance.lower", "time_to_most_negative_slope", "mean", "min", "AUC_trapezoidal_integration"), 
          c("Delta (max-min)", "Time To Max", "Time*Distance", "Time To Most Negative Slope", "Mean", "Min", "AUC (trapezoidal integration)"), "Confluency Metrics - Q-Q Plot & Histogram")

```

Q-Q Plots - Assessing Distributions for each Metric
--------------

```{r, echo=FALSE}
# Function to extract legend
# From: https://github.com/hadley/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

# Get Q-Q Plot of the sample data for a particular feature (@param feature_name) against theoretical data with distribution (@param distribution)

# @param df -- data frame of data with features 
# @param feature_name -- name of feature whose distribution is in question
# @param title -- main title for all plots
get_qqplot_sample_theoretical <- function(df, feature_name, title) {
  df$feature <- df[, colnames(df) == feature_name]
  normal <- ggplot(df, aes(sample = scale(feature))) + stat_qq(distribution = qnorm, aes(colour = empty)) + geom_abline(intercept=0, slope=1) + ggtitle("Normal Distribution") + theme(legend.position="bottom") 
  lognormal <- ggplot(df, aes(sample = scale(feature))) + stat_qq(distribution = qlnorm, aes(colour = empty)) + geom_abline(intercept=0, slope=1) + ggtitle("Lognormal Distribution") 
  logistic <- ggplot(df, aes(sample = scale(feature))) + stat_qq(distribution = qlogis, aes(colour = empty)) + geom_abline(intercept=0, slope=1) + ggtitle("Logistic Distribution") 
  cauchy <- ggplot(df, aes(sample = scale(feature))) + stat_qq(distribution = qcauchy, aes(colour = empty)) + geom_abline(intercept=0, slope=1) + ggtitle("Cauchy Distribution") 
  unif <- ggplot(df, aes(sample = scale(feature))) + stat_qq(distribution = qunif, aes(colour = empty)) + geom_abline(intercept=0, slope=1) + ggtitle("Uniform Distribution") 
  mylegend<-g_legend(normal)
  grid.arrange(arrangeGrob(
    normal + theme(legend.position="none"), 
    lognormal + theme(legend.position="none"), 
    logistic + theme(legend.position="none"), 
    cauchy + theme(legend.position="none"), 
    unif + theme(legend.position="none"), 
    ncol = 3), nrow = 2, heights=c(10, 1), main = title, mylegend)
}

# Plot Q-Q Plots for various metrics.

get_qqplot_sample_theoretical(sytoxG_data_features, "delta_min_max", "Q-Q Plots for Sytox Green: Delta (max-min)")
get_qqplot_sample_theoretical(confluency_data_features, "delta_min_max", "Q-Q Plots for Confluency: Delta (max-min)")

get_qqplot_sample_theoretical(sytoxG_data_features, "time_to_max", "Q-Q Plots for Sytox Green: Time to Max")
get_qqplot_sample_theoretical(confluency_data_features, "time_to_max", "Q-Q Plots for Confluency: Time to Max")

# SG uses time x distance UPPER, Con uses time x distance LOWER
get_qqplot_sample_theoretical(sytoxG_data_features, "time_x_distance.upper", "Q-Q Plots for Sytox Green: Time*Distance")
get_qqplot_sample_theoretical(confluency_data_features, "time_x_distance.lower", "Q-Q Plots for Confluency: Time*Distance")

get_qqplot_sample_theoretical(sytoxG_data_features, "M.w.", "Q-Q Plots for Sytox Green: Molecular Weight")
get_qqplot_sample_theoretical(confluency_data_features, "M.w.", "Q-Q Plots for Confluency: Molecular Weight")

get_qqplot_sample_theoretical(sytoxG_data_features, "Max.Solubility.in.DMSO", "Q-Q Plots for Sytox Green: Molecular Weight")
get_qqplot_sample_theoretical(sytoxG_data_features, "Max.Solubility.in.DMSO", "Q-Q Plots for Confluency: Molecular Weight")
```

At what time point do we see the first significant differences in phenotypic marker values? 
------------------
In Sytox Green?

```{r, echo=FALSE}

# At what time point do we see the first significant differences in phenotypic marker values? 
sig_level <- 0.05
#  --> For SG? 
fit_SG <- lm(phenotype_value ~ as.factor(time_elapsed), data_for_stats, subset = phenotypic_Marker == "SG")
print(summary(fit_SG))
summary <- as.data.frame(summary(fit_SG)$coef)
first_sig_timepoint <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])[2]
print(paste("The first significant time point for Sytox Green after the hour 0 is hour ",gsub("as.factor\\(time_elapsed\\)","",first_sig_timepoint),".",sep=""))
```

In Confluency?

```{r, echo=FALSE}
#  --> For Confluency?
fit_con <- lm(phenotype_value ~ as.factor(time_elapsed), data_for_stats, subset = phenotypic_Marker == "Con")
print(summary(fit_con))
summary <- as.data.frame(summary(fit_con)$coef)
first_sig_timepoint <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])[2]
print(paste("The first significant time point for Confluency after the hour 0 is hour ",gsub("as.factor\\(time_elapsed\\)","",first_sig_timepoint),".",sep=""))
```

Which pathways are significantly different from the negative controls (measured by AUC)? 
------------------

For Sytox Green:

```{r, echo=FALSE}
# --> SG
fit_SG <- lm(AUC_trapezoidal_integration ~ Pathway, data_for_stats, subset = phenotypic_Marker == "SG")
summary <-  as.data.frame(summary(fit_SG)$coef)
sig_level <- 0.01
sig_pathways_SG <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])
sig_pathways_SG <- gsub("Pathway","",sig_pathways_SG)
print(paste("The following pathways have an AUC for Sytox Green significantly different (p < ",sig_level,") from the negative controls' AUC?",sep=""))
print(sig_pathways_SG[2:length(sig_pathways_SG)])
```

For Confluency:

```{r, echo=FALSE} 
# --> Con
fit_Con <- lm(AUC_trapezoidal_integration ~ Pathway, data_for_stats, subset = phenotypic_Marker == "Con")
summary <-  as.data.frame(summary(fit_Con)$coef)
sig_level <- 0.01
sig_pathways_Con <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])
sig_pathways_Con <- gsub("Pathway","",sig_pathways_Con)
print(paste("The following pathways have an AUC for Confluency significantly different (p < ",sig_level,") from the negative controls' AUC?",sep=""))
print(sig_pathways_Con[2:length(sig_pathways_Con)])
```

Which targets are significantly different from the negative controls (measured by AUC)?
------------------------

For Sytox Green:

```{r, echo=FALSE}
# --> SG
fit_SG <- lm(AUC_trapezoidal_integration ~ Targets..as.supplied., data_for_stats, subset = phenotypic_Marker == "SG")
summary <-  as.data.frame(summary(fit_SG)$coef)
sig_level <- 1e-20
sig_targets_SG <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])
sig_targets_SG <- gsub("Targets..as.supplied.","",sig_targets_SG)
print(paste("The following targets have an AUC for Sytox Green significantly different (p < ",sig_level,") from the negative controls' AUC?",sep=""))
print(sig_targets_SG[2:length(sig_targets_SG)])
```

Sytox Green sparklines for the significant targets:

```{r,echo=FALSE}
sytoxG_data_significant_targets_only <- sytoxG_data[which(sytoxG_data$Targets..as.supplied. %in% sig_targets_SG) , ]
ggplot(sytoxG_data_significant_targets_only) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound)) +
  geom_ribbon(data = confidence_intervals_SG, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                             fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  xlab("Time Elapsed") +
  ylab("Sytox Green") +
  ggtitle(paste("Sytox Green - Significant Targets (p < ", sig_level, ")",sep="")) +
  facet_wrap(~Targets..as.supplied., ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank(),
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical")
```

For Confluency:

```{r, echo=FALSE}
# --> Con
fit_Con <- lm(AUC_trapezoidal_integration ~ Targets..as.supplied., data_for_stats, subset = phenotypic_Marker == "Con")
summary <-  as.data.frame(summary(fit_Con)$coef)
sig_level <- 1e-20
sig_targets_Con <- rownames(summary[summary[,"Pr(>|t|)"] < sig_level,])
sig_targets_Con <- gsub("Targets..as.supplied.","",sig_targets_Con)
print(paste("The following targets have an AUC for Confluency significantly different (p < ",sig_level,") from the negative controls' AUC?",sep=""))
print(sig_targets_Con[2:length(sig_targets_Con)])
```

Confluency sparklines for the significant targets:

```{r,echo=FALSE}
confluency_data_significant_targets_only <- confluency_data[which(confluency_data$Targets..as.supplied. %in% sig_targets_Con) , ]
ggplot(confluency_data_significant_targets_only) +
  geom_line(aes(x=as.numeric(time_elapsed), y=as.numeric(phenotype_value), group=Compound)) +
  geom_ribbon(data = confidence_intervals_Con, mapping = aes(x = time_elapsed, ymin = phenotype_value.NC.lower, ymax = phenotype_value.NC.upper,
                                                             fill = "red", colour = NULL), alpha = 0.6) +
  scale_fill_manual(name = "Legend",
                    values = c('red'),
                    labels = c('Negative Control\n99.9% C.I.')) +
  xlab("Time Elapsed") +
  ylab("Confluency") +
  ggtitle(paste("Confluency - Significant Targets (p < ", sig_level, ")",sep="")) +
  facet_wrap(~Targets..as.supplied., ncol=6, scales = "fixed") +
  theme(panel.grid = element_blank(),
        axis.ticks.length = unit(0, "cm"),
        panel.background = element_rect(fill = "white"),
        strip.text.x = element_text(size=4),
        axis.text = element_blank(), 
        legend.key.size = unit(0.4, "cm"),
        legend.direction="vertical")
```
